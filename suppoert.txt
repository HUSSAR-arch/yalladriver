import React, { useEffect, useState, useRef } from 'react';
import { supabase } from '../services/supabase';
import { 
  MessageCircle, 
  User, 
  Send, 
  CheckCircle, 
  Search, 
  Phone, 
  CreditCard, 
  Clock, 
  MoreVertical,
  Filter
} from 'lucide-react';

// --- Types ---
interface Profile {
  id: string;
  full_name: string;
  email: string;
  phone: string;
  balance: number;
}

export interface SupportTicket {
  id: string;
  user_id: string;
  subject: string;
  status: 'open' | 'resolved';
  category: string;
  created_at: string;
  updated_at: string;
  profiles: Profile;
}

export interface SupportMessage {
  id: string;
  ticket_id: string;
  sender_id: string;
  message_text: string;
  is_admin: boolean;
  created_at: string;
}

export default function SupportPage() {
  // --- State ---
  const [tickets, setTickets] = useState<SupportTicket[]>([]);
  const [filteredTickets, setFilteredTickets] = useState<SupportTicket[]>([]);
  const [selectedTicket, setSelectedTicket] = useState<SupportTicket | null>(null);
  const [messages, setMessages] = useState<SupportMessage[]>([]);
  const [replyText, setReplyText] = useState('');
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'open' | 'resolved'>('all');

  // --- Refs ---
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // --- Effects ---

  // 1. Initial Load & Audio Setup
  useEffect(() => {
    fetchTickets();
    audioRef.current = new Audio('/notification.mp3'); // Ensure this file exists in public folder
  }, []);

  // 2. Filter Logic
  useEffect(() => {
    let result = tickets;

    // Filter by Search
    if (searchQuery) {
      const lowerQuery = searchQuery.toLowerCase();
      result = result.filter(t => 
        t.subject.toLowerCase().includes(lowerQuery) || 
        t.profiles?.full_name?.toLowerCase().includes(lowerQuery) ||
        t.id.includes(lowerQuery)
      );
    }

    // Filter by Status
    if (filterStatus !== 'all') {
      result = result.filter(t => t.status === filterStatus);
    }

    setFilteredTickets(result);
  }, [tickets, searchQuery, filterStatus]);

  // 3. Ticket Selection & Subscription
  useEffect(() => {
    if (selectedTicket) {
      fetchMessages(selectedTicket.id);

      // Real-time Subscription
      const channel = supabase
        .channel(`ticket-${selectedTicket.id}`)
        .on(
          'postgres_changes', 
          { event: 'INSERT', schema: 'public', table: 'support_messages', filter: `ticket_id=eq.${selectedTicket.id}`}, 
          (payload) => {
            const newMsg = payload.new as SupportMessage;
            setMessages(prev => [...prev, newMsg]);
            
            // Play sound if message is NOT from admin
            if (!newMsg.is_admin) {
              audioRef.current?.play().catch(() => {});
            }
          }
        )
        .subscribe();

      return () => { supabase.removeChannel(channel); };
    }
  }, [selectedTicket]);

  // 4. Auto-scroll to bottom
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // --- Functions ---

  const fetchTickets = async () => {
    setLoading(true);
    // Fetch tickets WITH detailed profile data (balance, phone)
    const { data } = await supabase
      .from('support_tickets')
      .select('*, profiles(id, full_name, email, phone, balance)') 
      .order('updated_at', { ascending: false });
    
    if (data) {
      setTickets(data as any);
      setFilteredTickets(data as any);
    }
    setLoading(false);
  };

  const fetchMessages = async (ticketId: string) => {
    const { data } = await supabase
      .from('support_messages')
      .select('*')
      .eq('ticket_id', ticketId)
      .order('created_at', { ascending: true });
    if (data) setMessages(data as SupportMessage[]);
  };

  const handleSendReply = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!replyText.trim() || !selectedTicket) return;

    // Optimistic UI Update (makes it feel faster)
    const tempId = Math.random().toString();
    const optimisticMsg: SupportMessage = {
      id: tempId,
      ticket_id: selectedTicket.id,
      sender_id: 'admin',
      message_text: replyText,
      is_admin: true,
      created_at: new Date().toISOString()
    };
    setMessages(prev => [...prev, optimisticMsg]);
    setReplyText('');

    const { error } = await supabase.from('support_messages').insert({
      ticket_id: selectedTicket.id,
      sender_id: 'admin', // Replace with actual logged-in admin ID context
      message_text: optimisticMsg.message_text,
      is_admin: true
    });

    if (error) {
      // Revert if failed
      setMessages(prev => prev.filter(m => m.id !== tempId));
      alert("Failed to send message");
    } else {
      // Update timestamp on ticket
      await supabase.from('support_tickets').update({ updated_at: new Date() }).eq('id', selectedTicket.id);
      fetchTickets(); // Refresh list to bump ticket to top
    }
  };

  const handleResolveTicket = async () => {
    if (!selectedTicket) return;
    const { error } = await supabase
      .from('support_tickets')
      .update({ status: 'resolved' })
      .eq('id', selectedTicket.id);
    
    if (!error) {
      // Local update
      const updated = { ...selectedTicket, status: 'resolved' } as SupportTicket;
      setSelectedTicket(updated);
      setTickets(prev => prev.map(t => t.id === updated.id ? updated : t));
    }
  };

  return (
    <div className="h-[calc(100vh-20px)] bg-slate-50 flex gap-4 p-4 overflow-hidden font-sans text-slate-900">
      
      {/* --- COLUMN 1: Ticket List --- */}
      <div className={`flex-1 min-w-[300px] max-w-[380px] bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col ${selectedTicket ? 'hidden lg:flex' : 'flex'}`}>
        {/* Header & Search */}
        <div className="p-4 border-b border-slate-100 space-y-3">
          <div className="flex justify-between items-center">
            <h2 className="font-bold text-xl">Inbox</h2>
            <div className="bg-slate-100 text-xs font-bold px-2 py-1 rounded-md text-slate-600">
              {filteredTickets.length}
            </div>
          </div>
          
          {/* Search Bar */}
          <div className="relative">
            <Search size={16} className="absolute left-3 top-3 text-slate-400" />
            <input 
              type="text"
              placeholder="Search tickets..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all"
            />
          </div>

          {/* Filter Tabs */}
          <div className="flex gap-2 text-xs">
            {['all', 'open', 'resolved'].map((status) => (
              <button
                key={status}
                onClick={() => setFilterStatus(status as any)}
                className={`px-3 py-1.5 rounded-lg capitalize transition-colors ${
                  filterStatus === status 
                    ? 'bg-slate-900 text-white' 
                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                }`}
              >
                {status}
              </button>
            ))}
          </div>
        </div>

        {/* List */}
        <div className="flex-1 overflow-y-auto">
          {loading ? (
            <div className="p-8 text-center text-slate-400 text-sm">Loading tickets...</div>
          ) : filteredTickets.length === 0 ? (
            <div className="p-8 text-center text-slate-400 text-sm">No tickets found</div>
          ) : (
            filteredTickets.map(ticket => (
              <button
                key={ticket.id}
                onClick={() => setSelectedTicket(ticket)}
                className={`w-full text-left p-4 border-b border-slate-50 hover:bg-slate-50 transition-all ${
                  selectedTicket?.id === ticket.id ? 'bg-indigo-50/50 border-l-4 border-l-indigo-600' : 'border-l-4 border-l-transparent'
                }`}
              >
                <div className="flex justify-between mb-1.5">
                  <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full tracking-wide ${
                    ticket.status === 'open' ? 'bg-amber-100 text-amber-700' : 'bg-emerald-100 text-emerald-700'
                  }`}>
                    {ticket.status.toUpperCase()}
                  </span>
                  <span className="text-[10px] text-slate-400 flex items-center gap-1">
                    {new Date(ticket.created_at).toLocaleDateString()}
                  </span>
                </div>
                <h3 className="font-semibold text-slate-900 truncate mb-1">{ticket.subject}</h3>
                <p className="text-xs text-slate-500 truncate flex items-center gap-1">
                  <User size={10} /> {ticket.profiles?.full_name || 'Unknown User'}
                </p>
              </button>
            ))
          )}
        </div>
      </div>

      {/* --- COLUMN 2: Chat Window --- */}
      {selectedTicket ? (
        <div className="flex-[2] bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden relative">
          
          {/* Chat Header */}
          <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white z-10">
            <div className="flex items-center gap-3">
              <button onClick={() => setSelectedTicket(null)} className="lg:hidden p-2 -ml-2 text-slate-500">
                <ArrowLeft size={20} />
              </button>
              <div>
                <h3 className="font-bold text-slate-900 text-lg">{selectedTicket.subject}</h3>
                <span className="text-xs text-slate-500">Ticket ID: #{selectedTicket.id.slice(0,8)}</span>
              </div>
            </div>
            {selectedTicket.status === 'open' && (
              <button 
                onClick={handleResolveTicket}
                className="flex items-center gap-2 px-4 py-2 bg-emerald-50 text-emerald-700 text-sm font-semibold rounded-xl hover:bg-emerald-100 transition-colors border border-emerald-100"
              >
                <CheckCircle size={16} /> Mark Resolved
              </button>
            )}
          </div>

          {/* Messages Area */}
          <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-50/50">
            {messages.map((msg, index) => {
              // Group consecutive messages logic could go here
              return (
                <div key={msg.id || index} className={`flex ${msg.is_admin ? 'justify-end' : 'justify-start'}`}>
                  <div className={`max-w-[75%] rounded-2xl p-4 shadow-sm ${
                    msg.is_admin 
                      ? 'bg-indigo-600 text-white rounded-br-sm' 
                      : 'bg-white border border-slate-200 text-slate-800 rounded-bl-sm'
                  }`}>
                    <p className="text-sm leading-relaxed whitespace-pre-wrap">{msg.message_text}</p>
                    <p className={`text-[10px] mt-2 text-right opacity-70`}>
                      {new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                    </p>
                  </div>
                </div>
              );
            })}
            <div ref={messagesEndRef} />
          </div>

          {/* Input Area */}
          <form onSubmit={handleSendReply} className="p-4 bg-white border-t border-slate-100">
            <div className="flex gap-3 items-end">
              <textarea 
                value={replyText}
                onChange={(e) => setReplyText(e.target.value)}
                onKeyDown={(e) => {
                  if(e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendReply(e);
                  }
                }}
                placeholder="Type your reply... (Press Enter to send)"
                className="flex-1 px-4 py-3 min-h-[50px] max-h-[120px] rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/20 focus:border-indigo-500 resize-none text-sm"
              />
              <button 
                type="submit"
                disabled={!replyText.trim()}
                className="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-md shadow-indigo-200"
              >
                <Send size={20} />
              </button>
            </div>
          </form>
        </div>
      ) : (
        /* Empty State */
        <div className="hidden lg:flex flex-[2] bg-white rounded-2xl border border-slate-200 shadow-sm items-center justify-center text-slate-400 flex-col gap-4">
          <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center">
            <MessageCircle size={32} className="text-slate-300" />
          </div>
          <p className="font-medium">Select a ticket to view details</p>
        </div>
      )}

      {/* --- COLUMN 3: Customer Context (Sidebar) --- */}
      {selectedTicket && (
        <div className="hidden xl:flex w-[300px] bg-white rounded-2xl border border-slate-200 shadow-sm flex-col overflow-hidden">
          <div className="p-4 border-b border-slate-100 bg-slate-50/50">
            <h3 className="font-bold text-slate-800">Customer Details</h3>
          </div>
          
          <div className="p-6 flex flex-col items-center border-b border-slate-100">
            <div className="w-20 h-20 bg-indigo-50 rounded-full flex items-center justify-center mb-3 text-indigo-600 font-bold text-2xl">
              {selectedTicket.profiles?.full_name?.charAt(0).toUpperCase()}
            </div>
            <h2 className="font-bold text-lg text-slate-900 text-center">{selectedTicket.profiles?.full_name}</h2>
            <p className="text-slate-500 text-sm">{selectedTicket.profiles?.email}</p>
          </div>

          <div className="p-6 space-y-6">
            {/* Balance Card */}
            <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
              <div className="flex items-center gap-2 text-slate-500 mb-1">
                <CreditCard size={14} />
                <span className="text-xs font-semibold uppercase tracking-wider">Wallet Balance</span>
              </div>
              <div className="text-2xl font-bold text-slate-900">
                {selectedTicket.profiles?.balance?.toLocaleString()} <span className="text-sm font-medium text-slate-500">DZD</span>
              </div>
            </div>

            {/* Contact Info */}
            <div>
              <div className="flex items-center gap-2 text-slate-500 mb-2">
                <Phone size={14} />
                <span className="text-xs font-semibold uppercase tracking-wider">Phone Number</span>
              </div>
              <p className="text-slate-900 font-medium">{selectedTicket.profiles?.phone || 'No phone linked'}</p>
            </div>

            {/* Ticket Info */}
            <div>
              <div className="flex items-center gap-2 text-slate-500 mb-2">
                <Clock size={14} />
                <span className="text-xs font-semibold uppercase tracking-wider">Ticket Created</span>
              </div>
              <p className="text-slate-900 text-sm">
                {new Date(selectedTicket.created_at).toLocaleString()}
              </p>
              <div className="mt-2 inline-block px-2 py-1 bg-slate-100 rounded text-xs text-slate-600">
                Category: {selectedTicket.category || 'General'}
              </div>
            </div>
          </div>
        </div>
      )}

    </div>
  );
}

// Helper component for mobile back button
function ArrowLeft({ size }: { size: number }) {
    return (
        <svg 
            width={size} 
            height={size} 
            viewBox="0 0 24 24" 
            fill="none" 
            stroke="currentColor" 
            strokeWidth="2" 
            strokeLinecap="round" 
            strokeLinejoin="round"
        >
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
    );
}